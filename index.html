<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru - Dasbor Ujian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Pop Up/Modal Login Guru -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-slate-800">Login Portal Guru</h2>
            <p class="text-center text-slate-500 mt-2">Masukkan kredensial untuk mengakses dasbor.</p>
            <div class="mt-6 space-y-4">
                <div>
                    <label for="teacher-id" class="block text-sm font-medium text-slate-700">ID Guru</label>
                    <input type="text" id="teacher-id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-3">
                </div>
                <div>
                    <label for="teacher-password" class="block text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="teacher-password" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-3">
                </div>
                <p id="login-error" class="text-red-500 text-sm h-4"></p>
                <div class="flex justify-end">
                    <button id="submit-login-button" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Konten Utama Dasbor (Awalnya Tersembunyi) -->
    <main id="main-content" class="min-h-screen hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-600 p-2 rounded-lg">
                            <svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Portal Guru</h1>
                            <p class="text-sm text-slate-500">Dasbor Ujian Terpadu</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-1 bg-indigo-500"></div>
        </header>

        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <!-- Navigasi Tab -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-monitor" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-slate-500 hover:text-slate-700 hover:border-slate-300">Monitor Sesi Live</button>
                        <button id="tab-history" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-slate-500 hover:text-slate-700 hover:border-slate-300">Riwayat Pelanggaran</button>
                        <button id="tab-analysis" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-slate-500 hover:text-slate-700 hover:border-slate-300">Analisis Jawaban</button>
                    </nav>
                </div>

                <!-- Konten Tab -->
                <div class="mt-6">
                    <!-- Konten Tab Monitor -->
                    <div id="content-monitor" class="tab-content">
                        <div id="monitor-selection-screen">
                            <div class="text-center">
                                <h2 class="text-2xl font-bold text-slate-700">Pilih Sesi untuk Dipantau</h2>
                            </div>
                            <div class="mt-6 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button id="monitor-utama-btn" class="bg-white p-8 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                    <h3 class="text-xl font-bold text-indigo-600">Ulangan Utama</h3>
                                </button>
                                <button id="monitor-remedial-btn" class="bg-white p-8 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                                    <h3 class="text-xl font-bold text-cyan-600">Remedial</h3>
                                </button>
                            </div>
                        </div>
                        <div id="monitor-display-screen" class="hidden">
                            <div class="text-center mb-6 relative">
                                <button id="monitor-back-button" class="absolute top-0 left-0 bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">&larr; Kembali</button>
                                <h2 id="monitor-title" class="text-3xl font-bold text-slate-800"></h2>
                                <div id="live-stats" class="mt-2">
                                    <p class="font-semibold text-slate-700">Status: <span class="text-green-600">● Live</span></p>
                                    <p class="text-sm text-slate-500">Total Murid Mengerjakan: <span id="student-count" class="font-bold">0</span></p>
                                </div>
                                <button id="reset-live-session-button" class="absolute top-0 right-0 bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">Reset Sesi Live</button>
                            </div>
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <div id="student-list" class="divide-y divide-slate-200"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Konten Tab Riwayat -->
                    <div id="content-history" class="tab-content hidden">
                         <div class="bg-white rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-slate-800">Riwayat Pelanggaran Pindah Tab</h2>
                                <button id="clear-history-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Hapus Semua Riwayat</button>
                            </div>
                            <div id="history-list" class="divide-y divide-slate-200"></div>
                        </div>
                    </div>

                    <!-- Konten Tab Analisis -->
                    <div id="content-analysis" class="tab-content hidden">
                         <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg">
                            <h2 class="text-2xl font-bold text-slate-800 mb-4">Analisis Jawaban Murid</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">1. Pilih Ujian</label>
                                    <select id="exam-type-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                        <option value="">-- Pilih --</option>
                                        <option value="utama">Ulangan Utama</option>
                                        <option value="remedial">Remedial</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="class-select" class="block text-sm font-medium text-slate-700">2. Pilih Kelas</label>
                                    <select id="class-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" disabled>
                                        <option>--</option>
                                    </select>
                                </div>
                            </div>
                            <div id="analysis-type-selection" class="hidden mt-4 pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                    <h3 class="font-semibold text-slate-800">Analisis Per Kelas</h3>
                                    <p class="text-sm text-slate-500 mb-2">Lihat rekapitulasi jawaban untuk seluruh kelas.</p>
                                    <button id="show-class-analysis-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700">
                                        Tampilkan Analisis Kelas
                                    </button>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-slate-800">Analisis Per Murid</h3>
                                    <p class="text-sm text-slate-500 mb-2">Pilih murid spesifik untuk melihat detail jawaban.</p>
                                    <div class="grid grid-cols-2 gap-2 items-end">
                                        <select id="student-select" class="block w-full rounded-md border-slate-300 shadow-sm p-2" disabled>
                                            <option value="">-- Pilih Murid --</option>
                                        </select>
                                        <button id="show-student-analysis-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400" disabled>
                                            Tampilkan
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <p id="loading-status" class="text-center text-sm text-slate-500 mt-2 h-4"></p>
                        </div>
                        <div id="student-analysis-result-container" class="mt-6 max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md hidden">
                            <div class="mb-6 border-b pb-4">
                                <h2 class="text-2xl font-bold text-slate-800">Hasil Analisis Murid</h2>
                                <div class="mt-2 grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-sm text-slate-500">Nama Murid</p>
                                        <p id="student-name-result" class="font-bold text-lg"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-slate-500">Kelas</p>
                                        <p id="student-class-result" class="font-bold text-lg"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-slate-500">Skor Akhir</p>
                                        <p id="student-score-result" class="font-bold text-lg"></p>
                                    </div>
                                </div>
                            </div>
                            <div id="question-analysis-list" class="space-y-4"></div>
                        </div>
                        <div id="class-analysis-result-container" class="mt-6 max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md hidden">
                            <div class="mb-6 border-b pb-4">
                                <h2 class="text-2xl font-bold text-slate-800">Hasil Analisis Kelas</h2>
                                <div class="mt-2 grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-sm text-slate-500">Kelas</p>
                                        <p id="class-name-result" class="font-bold text-lg"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-slate-500">Jumlah Peserta</p>
                                        <p id="class-student-count" class="font-bold text-lg"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-slate-500">Rata-rata Skor</p>
                                        <p id="class-average-score" class="font-bold text-lg"></p>
                                    </div>
                                </div>
                            </div>
                            <div id="gemini-feature-container" class="my-6">
                                <button id="generate-summary-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">
                                    ✨ Buat Ringkasan Analisis dengan AI
                                </button>
                                <div id="ai-summary-container" class="mt-4 hidden p-4 border rounded-lg bg-slate-50">
                                    <h3 class="text-lg font-bold text-slate-800 mb-2">Ringkasan Analisis AI</h3>
                                    <div id="ai-summary-content" class="text-slate-700 space-y-2"></div>
                                </div>
                            </div>
                            <div id="class-question-analysis-list" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

     <!-- Pop Up Konfirmasi Hapus Riwayat -->
    <div id="clear-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"></div>
    <div id="delete-entry-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"></div>

    <!-- Pop Up Konfirmasi Reset Sesi Live -->
    <div id="reset-live-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- PENGATURAN DATA ---
        const teacherLoginSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1382150609&single=true&output=csv';
        const answerSheetURLs = {
            utama: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=4366504&single=true&output=csv',
            remedial: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=932637125&single=true&output=csv'
        };
        const quizURLs = {
            'Kelas X': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=427248072&single=true&output=csv',
            'Kelas XI': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=0&single=true&output=csv',
            'Kelas XII': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1252248885&single=true&output=csv',
        };
        
        // --- PENGATURAN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZCth3DrMVVdi0ONJgXv7DuoHJsf8-M5Q",
            authDomain: "aplikasi-ulangan-sejarah.firebaseapp.com",
            projectId: "aplikasi-ulangan-sejarah",
            storageBucket: "aplikasi-ulangan-sejarah.appspot.com",
            messagingSenderId: "571845428965",
            appId: "1:571845428965:web:a8c4e5da384fbf798fb60c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // --- KODE LENGKAP UNTUK SEMUA FUNGSI ---
        const allElements = {
            loginModal: document.getElementById('login-modal'), submitLoginButton: document.getElementById('submit-login-button'),
            teacherIdInput: document.getElementById('teacher-id'), teacherPasswordInput: document.getElementById('teacher-password'),
            loginError: document.getElementById('login-error'), mainContent: document.getElementById('main-content'),
            tabMonitor: document.getElementById('tab-monitor'), tabHistory: document.getElementById('tab-history'),
            tabAnalysis: document.getElementById('tab-analysis'), contentMonitor: document.getElementById('content-monitor'),
            contentHistory: document.getElementById('content-history'), contentAnalysis: document.getElementById('content-analysis'),
            monitorSelectionScreen: document.getElementById('monitor-selection-screen'), monitorDisplayScreen: document.getElementById('monitor-display-screen'),
            monitorUtamaBtn: document.getElementById('monitor-utama-btn'), monitorRemedialBtn: document.getElementById('monitor-remedial-btn'),
            monitorBackButton: document.getElementById('monitor-back-button'), monitorTitle: document.getElementById('monitor-title'),
            studentCount: document.getElementById('student-count'), studentList: document.getElementById('student-list'),
            liveStats: document.getElementById('live-stats'), historyList: document.getElementById('history-list'),
            clearHistoryButton: document.getElementById('clear-history-button'), clearHistoryModal: document.getElementById('clear-history-modal'),
            deleteEntryModal: document.getElementById('delete-entry-modal'), 
            resetLiveSessionButton: document.getElementById('reset-live-session-button'),
            resetLiveModal: document.getElementById('reset-live-modal'),
            examTypeSelect: document.getElementById('exam-type-select'),
            classSelect: document.getElementById('class-select'),
            studentSelect: document.getElementById('student-select'),
            showStudentAnalysisBtn: document.getElementById('show-student-analysis-btn'),
            showClassAnalysisBtn: document.getElementById('show-class-analysis-btn'),
            analysisTypeSelection: document.getElementById('analysis-type-selection'),
            loadingStatus: document.getElementById('loading-status'),
            studentAnalysisResultContainer: document.getElementById('student-analysis-result-container'),
            classAnalysisResultContainer: document.getElementById('class-analysis-result-container'),
            studentNameResult: document.getElementById('student-name-result'),
            studentClassResult: document.getElementById('student-class-result'),
            studentScoreResult: document.getElementById('student-score-result'),
            questionAnalysisList: document.getElementById('question-analysis-list'),
            classNameResult: document.getElementById('class-name-result'),
            classStudentCount: document.getElementById('class-student-count'),
            classAverageScore: document.getElementById('class-average-score'),
            classQuestionAnalysisList: document.getElementById('class-question-analysis-list'),
            generateSummaryBtn: document.getElementById('generate-summary-btn'),
            aiSummaryContainer: document.getElementById('ai-summary-container'),
            aiSummaryContent: document.getElementById('ai-summary-content'),
        };

        let teacherCredentials = [], allSubmissions = [], allQuestions = [], classAnalysisData = {};
        let unsubscribe = null; let logIdToDelete = null; let currentMonitoringCollection = null;

        function parseCSV(csvText){const rows=[];let inQuotes=!1,currentField="",currentRow=[];csvText=csvText.trim();for(let i=0;i<csvText.length;i++){const char=csvText[i],nextChar=csvText[i+1];if(inQuotes)char==='"'&&nextChar==='"'?(currentField+='"',i++):char==='"'?inQuotes=!1:currentField+=char;else if(char==='"')inQuotes=!0;else if(char===",")currentRow.push(currentField.trim()),currentField="";else if(char==="\n"||char==="\r")currentRow.push(currentField.trim()),rows.push(currentRow),currentRow=[],currentField="",char==="\r"&&nextChar==="\n"&&i++;else currentField+=char}if(currentField||currentRow.length>0)currentRow.push(currentField.trim()),rows.push(currentRow);return rows}
        async function fetchTeacherCredentials(){try{const response=await fetch(teacherLoginSheetURL);if(!response.ok)throw new Error("Gagal memuat data login guru.");const csvText=await response.text(),rows=parseCSV(csvText);rows.shift(),teacherCredentials=rows.map(row=>({id:row[0],password:row[1]})).filter(cred=>cred.id&&cred.password)}catch(error){console.error(error),allElements.loginError.textContent="Gagal memuat data kredensial."}}
        function handleLogin(){const id=allElements.teacherIdInput.value.trim(),password=allElements.teacherPasswordInput.value.trim();allElements.loginError.textContent="",id&&password?teacherCredentials.find(cred=>cred.id===id&&cred.password===password)?(allElements.loginModal.classList.add("hidden"),allElements.mainContent.classList.remove("hidden"),switchTab("monitor")):(allElements.loginError.textContent="ID atau Password salah."):allElements.loginError.textContent="ID dan Password tidak boleh kosong."}
        function switchTab(tabId){document.querySelectorAll(".tab-content").forEach(el=>el.classList.add("hidden")),document.querySelectorAll(".tab-button").forEach(el=>el.classList.remove("tab-active")),document.getElementById(`content-${tabId}`).classList.remove("hidden"),document.getElementById(`tab-${tabId}`).classList.add("tab-active"),unsubscribe&&unsubscribe(),unsubscribe=null,"monitor"===tabId?(allElements.monitorDisplayScreen.classList.add("hidden"),allElements.monitorSelectionScreen.classList.remove("hidden")):"history"===tabId?startHistoryMonitoring():"analysis"===tabId&&resetAnalysisTab()}
        function resetAnalysisTab(){allElements.examTypeSelect.value="",allElements.classSelect.innerHTML="<option>--</option>",allElements.classSelect.disabled=!0,allElements.analysisTypeSelection.classList.add("hidden"),allElements.studentAnalysisResultContainer.classList.add("hidden"),allElements.classAnalysisResultContainer.classList.add("hidden")}
        function showMonitoringScreen(type){allElements.monitorSelectionScreen.classList.add("hidden"),allElements.monitorDisplayScreen.classList.remove("hidden"),allElements.liveStats.classList.remove("hidden"),"utama"===type?(allElements.monitorTitle.textContent="Monitor Sesi Ulangan Utama",currentMonitoringCollection="exam_sessions",startMonitoring(currentMonitoringCollection,"Belum ada murid yang memulai ulangan...")):"remedial"===type&&(allElements.monitorTitle.textContent="Monitor Sesi Remedial",currentMonitoringCollection="remedial_sessions",startMonitoring(currentMonitoringCollection,"Belum ada murid yang memulai remedial..."))}
        function renderStudentList(students,emptyMessage){allElements.studentList.innerHTML="",allElements.studentCount.textContent=students.length;if(0===students.length){allElements.studentList.innerHTML=`<p class="text-slate-500 text-center py-8">${emptyMessage}</p>`;return}students.forEach(student=>{let statusClass="bg-green-100 text-green-800",statusText=student.status;"Beralih Tab"===student.status&&(statusClass="bg-red-100 text-red-800 animate-pulse",statusText="BERALIH TAB!");const studentElement=`\n                    <div class="flex items-center justify-between py-4">\n                        <div>\n                            <p class="font-bold text-lg text-slate-800">${student.nama}</p>\n                            <p class="text-sm text-slate-500">${student.kelas}</p>\n                        </div>\n                        <div class="text-right">\n                            <p class="font-semibold text-slate-700">Progres: ${student.soalDikerjakan} / ${student.totalSoal}</p>\n                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClass}">${statusText}</span>\n                        </div>\n                    </div>\n                `;allElements.studentList.innerHTML+=studentElement})}
        function renderHistoryList(logs){allElements.historyList.innerHTML="";if(0===logs.length){allElements.historyList.innerHTML='<p class="text-slate-500 text-center py-8">Tidak ada riwayat pelanggaran yang tercatat.</p>',allElements.clearHistoryButton.disabled=!0,allElements.clearHistoryButton.classList.add("opacity-50","cursor-not-allowed");return}allElements.clearHistoryButton.disabled=!1,allElements.clearHistoryButton.classList.remove("opacity-50","cursor-not-allowed"),logs.forEach(log=>{const timestamp=log.timestamp?log.timestamp.toDate().toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}):"Waktu tidak valid",typeClass="Remedial"===log.type?"bg-cyan-100 text-cyan-800":"bg-indigo-100 text-indigo-800",logElement=`\n                     <div class="flex items-center justify-between py-4 group">\n                        <div class="flex-1">\n                            <p class="font-bold text-lg text-slate-800">${log.nama}</p>\n                            <p class="text-sm text-slate-500">${log.kelas}</p>\n                        </div>\n                        <div class="text-right flex-1">\n                            <p class="text-sm text-slate-700">${timestamp} WIB</p>\n                            <span class="text-xs font-bold px-2 py-1 rounded-full ${typeClass}">Ujian: ${log.type}</span>\n                        </div>\n                        <div class="pl-4">\n                             <button data-log-id="${log.id}" data-student-name="${log.nama}" class="delete-history-btn bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm hover:bg-red-200 opacity-0 group-hover:opacity-100 transition-opacity">Hapus</button>\n                        </div>\n                    </div>\n                `;allElements.historyList.innerHTML+=logElement})}
        function startMonitoring(collectionName,emptyMessage){const sessionsRef=db.collection(collectionName);unsubscribe=sessionsRef.orderBy("last_updated","desc").onSnapshot(snapshot=>{const students=[];snapshot.forEach(doc=>{students.push(doc.data())}),renderStudentList(students,emptyMessage)},error=>{console.error("Gagal memonitor: ",error),allElements.studentList.innerHTML='<p class="text-red-500 text-center py-8">Gagal terhubung. Periksa koneksi dan pengaturan Firebase.</p>'})}
        function startHistoryMonitoring(){const historyRef=db.collection("cheating_log");unsubscribe=historyRef.orderBy("timestamp","desc").onSnapshot(snapshot=>{const logs=[];snapshot.forEach(doc=>{logs.push({id:doc.id,...doc.data()})}),renderHistoryList(logs)},error=>{console.error("Gagal memuat riwayat: ",error),allElements.historyList.innerHTML='<p class="text-red-500 text-center py-8">Gagal memuat riwayat. Periksa koneksi dan pengaturan Firebase.</p>'})}
        async function clearCheatingHistory(){const confirmBtn=document.getElementById("confirm-clear-history-btn");confirmBtn.disabled=!0;const clearStatus=document.getElementById("clear-status");clearStatus.textContent="Menghapus...";const historyRef=db.collection("cheating_log");try{const snapshot=await historyRef.get(),batch=db.batch();snapshot.docs.forEach(doc=>{batch.delete(doc.ref)}),await batch.commit(),console.log("Riwayat berhasil dihapus."),clearStatus.textContent="",confirmBtn.disabled=!1,allElements.clearHistoryModal.classList.add("hidden")}catch(error){console.error("Gagal menghapus riwayat: ",error),clearStatus.textContent="Gagal menghapus.",confirmBtn.disabled=!1}}
        function handleDeleteRequest(e){if(e.target.classList.contains("delete-history-btn")){logIdToDelete=e.target.dataset.logId;const studentName=e.target.dataset.studentName;document.getElementById("student-name-to-delete").textContent=studentName,allElements.deleteEntryModal.classList.remove("hidden")}}
        async function confirmDelete(){if(!logIdToDelete)return;try{await db.collection("cheating_log").doc(logIdToDelete).delete(),console.log("Entri riwayat berhasil dihapus:",logIdToDelete),allElements.deleteEntryModal.classList.add("hidden"),logIdToDelete=null}catch(error){console.error("Gagal menghapus entri:",error),alert("Gagal menghapus entri riwayat.")}}
        async function clearLiveSession(){if(!currentMonitoringCollection)return;allElements.confirmResetLiveBtn.disabled=!0,allElements.resetLiveStatus.textContent="Menghapus...";const collectionRef=db.collection(currentMonitoringCollection);try{const snapshot=await collectionRef.get(),batch=db.batch();snapshot.docs.forEach(doc=>{batch.delete(doc.ref)}),await batch.commit(),console.log("Sesi live berhasil direset."),allElements.resetLiveStatus.textContent="",allElements.confirmResetLiveBtn.disabled=!1,allElements.resetLiveModal.classList.add("hidden")}catch(error){console.error("Gagal mereset sesi live: ",error),allElements.resetLiveStatus.textContent="Gagal mereset.",allElements.confirmResetLiveBtn.disabled=!1}}
        async function fetchSubmissions(url){allElements.loadingStatus.textContent="Memuat data jawaban...";if(!url||!url.startsWith("https")){const errorMsg="URL untuk sheet jawaban ini belum diatur. Silakan periksa konfigurasi.";return allElements.loadingStatus.textContent=`Error: ${errorMsg}`,console.error(errorMsg),[]}try{const response=await fetch(url+"&t="+new Date().getTime());if(!response.ok)throw new Error("Gagal memuat data jawaban.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows.shift();return rows.map(row=>{const submission={};return headers&&headers.forEach((header,index)=>{submission[header]=row[index]}),submission})}catch(error){return console.error(error),allElements.loadingStatus.textContent="Error: "+error.message,[]}finally{allElements.loadingStatus.textContent=""}}
        async function fetchQuestionBank(url){allElements.loadingStatus.textContent="Memuat bank soal...";try{const response=await fetch(url+"&t="+new Date().getTime());if(!response.ok)throw new Error("Gagal memuat bank soal.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows.shift(),colMap={soal:headers.indexOf("Soal"),opsiA:headers.indexOf("Opsi A"),opsiB:headers.indexOf("Opsi B"),opsiC:headers.indexOf("Opsi C"),opsiD:headers.indexOf("Opsi D"),opsiE:headers.indexOf("Opsi E"),kunci:headers.indexOf("Kunci Jawaban")};return rows.map((columns,index)=>{const key=columns[colMap.kunci]?.toUpperCase().trim();let answer="";return"A"===key?answer=columns[colMap.opsiA]:"B"===key?answer=columns[colMap.opsiB]:"C"===key?answer=columns[colMap.opsiC]:"D"===key?answer=columns[colMap.opsiD]:"E"===key&&(answer=columns[colMap.opsiE]),{question:columns[colMap.soal],answer:answer,originalIndex:index+1}}).filter(q=>q.question&&q.answer)}catch(error){return console.error(error),allElements.loadingStatus.textContent="Error: "+error.message,[]}finally{allElements.loadingStatus.textContent=""}}
        function populateClassSelect(){const classes=[...new Set(allSubmissions.map(s=>s.Kelas))].filter(Boolean);allElements.classSelect.innerHTML='<option value="">-- Pilih Kelas --</option>',classes.sort().forEach(c=>{allElements.classSelect.innerHTML+=`<option value="${c}">${c}</option>`}),allElements.classSelect.disabled=!1}
        function populateStudentSelect(){const selectedClass=allElements.classSelect.value,studentsInClass=allSubmissions.filter(s=>s.Kelas===selectedClass);allElements.studentSelect.innerHTML='<option value="">-- Pilih Murid --</option>',studentsInClass.forEach((s,index)=>{const timestamp=new Date(s.Timestamp).toLocaleString("id-ID");allElements.studentSelect.innerHTML+=`<option value="${index}">${s.Nama} (${timestamp})</option>`})}
        function parseStudentAnswerLog(logString){const answers={};if(!logString)return answers;const entries=logString.split(";");return entries.forEach(entry=>{const match=entry.match(/Soal (\d+): "([^"]*)" \((Benar|Salah)\)/);match&&(answers[match[1]]={answer:match[2],isCorrect:"Benar"===match[3]})}),answers}
        function displayStudentAnalysis(studentSubmission,questionBank){allElements.studentAnalysisResultContainer.innerHTML=`<div class="mb-6 border-b pb-4"><h2 class="text-2xl font-bold text-slate-800">Hasil Analisis Murid</h2><div class="mt-2 grid grid-cols-3 gap-4 text-center"><div><p class="text-sm text-slate-500">Nama Murid</p><p id="student-name-result" class="font-bold text-lg">${studentSubmission.Nama}</p></div><div><p class="text-sm text-slate-500">Kelas</p><p id="student-class-result" class="font-bold text-lg">${studentSubmission.Kelas}</p></div><div><p class="text-sm text-slate-500">Skor Akhir</p><p id="student-score-result" class="font-bold text-lg">${studentSubmission.Skor}</p></div></div></div><div id="question-analysis-list" class="space-y-4"></div>`,allElements.classAnalysisResultContainer.classList.add("hidden"),allElements.studentAnalysisResultContainer.classList.remove("hidden");const questionAnalysisList=document.getElementById("question-analysis-list");questionAnalysisList.innerHTML="";const studentAnswers=parseStudentAnswerLog(studentSubmission.Nomor_soal_dikerjakan),questionNumbersInLog=Object.keys(studentAnswers).map(Number).sort((a,b)=>a-b);questionNumbersInLog.forEach(qNumber=>{const questionData=questionBank.find(q=>q.originalIndex==qNumber),studentAnswerData=studentAnswers[qNumber];if(!questionData)return;const isCorrect=studentAnswerData.isCorrect,resultClass=isCorrect?"border-green-500 bg-green-50":"border-red-500 bg-red-50";let answerHtml=`<p class="mt-2 text-sm">Jawaban Murid: <span class="font-semibold text-green-700">${studentAnswerData.answer} (Benar)</span></p>`;isCorrect||(answerHtml=`\n                        <p class="mt-2 text-sm">Jawaban Murid: <span class="font-semibold text-red-700">${studentAnswerData.answer} (Salah)</span></p>\n                        <p class="mt-1 text-sm">Kunci Jawaban: <span class="font-semibold text-blue-700">${questionData.answer}</span></p>\n                    `);const questionElement=`\n                    <div class="p-4 border-l-4 ${resultClass} rounded-r-lg">\n                        <p class="font-semibold text-slate-800">Soal #${qNumber}: ${questionData.question}</p>\n                        ${answerHtml}\n                    </div>\n                `;questionAnalysisList.innerHTML+=questionElement})}
        function displayClassAnalysis(submissionsForClass,questionBank){allElements.classAnalysisResultContainer.innerHTML=`<div class="mb-6 border-b pb-4"><h2 class="text-2xl font-bold text-slate-800">Hasil Analisis Kelas</h2><div class="mt-2 grid grid-cols-3 gap-4 text-center"><div><p class="text-sm text-slate-500">Kelas</p><p id="class-name-result" class="font-bold text-lg"></p></div><div><p class="text-sm text-slate-500">Jumlah Peserta</p><p id="class-student-count" class="font-bold text-lg"></p></div><div><p class="text-sm text-slate-500">Rata-rata Skor</p><p id="class-average-score" class="font-bold text-lg"></p></div></div></div><div id="gemini-feature-container" class="my-6"><button id="generate-summary-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">✨ Buat Ringkasan Analisis dengan AI</button><div id="ai-summary-container" class="mt-4 hidden p-4 border rounded-lg bg-slate-50"><h3 class="text-lg font-bold text-slate-800 mb-2">Ringkasan Analisis AI</h3><div id="ai-summary-content" class="text-slate-700 space-y-2"></div></div></div><div id="class-question-analysis-list" class="space-y-4"></div>`,allElements.classAnalysisResultContainer.classList.remove("hidden"),allElements.studentAnalysisResultContainer.classList.add("hidden"),document.getElementById("generate-summary-btn").addEventListener("click",generateClassAnalysisSummary);const studentCount=submissionsForClass.length,totalScore=submissionsForClass.reduce((acc,s)=>acc+(parseInt(s.Skor)||0),0),avgScore=studentCount>0?(totalScore/studentCount).toFixed(1):0;document.getElementById("class-name-result").textContent=allElements.classSelect.value,document.getElementById("class-student-count").textContent=studentCount,document.getElementById("class-average-score").textContent=avgScore;const questionAnalysis={};submissionsForClass.forEach(submission=>{const studentAnswers=parseStudentAnswerLog(submission.Nomor_soal_dikerjakan);Object.keys(studentAnswers).forEach(qNumber=>{questionAnalysis[qNumber]||(questionAnalysis[qNumber]={correct:0,total:0,correctStudents:[]}),questionAnalysis[qNumber].total++,studentAnswers[qNumber].isCorrect&&(questionAnalysis[qNumber].correct++,questionAnalysis[qNumber].correctStudents.push(submission.Nama))})}),classAnalysisData={className:allElements.classSelect.value,studentCount:studentCount,averageScore:avgScore,questionDetails:[]};const classQuestionAnalysisList=document.getElementById("class-question-analysis-list");classQuestionAnalysisList.innerHTML="",questionBank.sort((a,b)=>a.originalIndex-b.originalIndex).forEach(qData=>{const qNumber=qData.originalIndex,analysis=questionAnalysis[qNumber];if(!analysis)return;const correctPercentage=analysis.correct/analysis.total*100;let bgColor="bg-green-100";correctPercentage<75&&(bgColor="bg-yellow-100"),correctPercentage<50&&(bgColor="bg-red-100"),classAnalysisData.questionDetails.push({nomorSoal:qNumber,teksSoal:qData.question.substring(0,100)+"...",persentaseBenar:correctPercentage.toFixed(0)});const correctStudentsList=analysis.correctStudents.length>0?analysis.correctStudents.join(", "):"Tidak ada",questionElement=`\n                    <div class="p-4 border rounded-lg ${bgColor}">\n                        <p class="font-semibold text-slate-800">Soal #${qNumber}: ${qData.question}</p>\n                        <p class="mt-2 text-sm">Kunci Jawaban: <span class="font-semibold text-blue-700">${qData.answer}</span></p>\n                        <div class="mt-2 text-sm">\n                            <span>Dijawab benar oleh <strong>${analysis.correct}</strong> dari <strong>${analysis.total}</strong> murid</span>\n                            <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1">\n                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${correctPercentage.toFixed(0)}%"></div>\n                            </div>\n                            <span class="font-bold float-right">${correctPercentage.toFixed(0)}%</span>\n                        </div>\n                        <details class="mt-3 text-sm">\n                            <summary class="cursor-pointer text-slate-600 hover:text-slate-900">Lihat Murid yang Menjawab Benar (${analysis.correct})</summary>\n                            <div class="mt-2 p-2 bg-white rounded border text-slate-700">\n                                ${correctStudentsList}\n                            </div>\n                        </details>\n                    </div>\n                `;classQuestionAnalysisList.innerHTML+=questionElement})}
        async function onShowStudentAnalysis(){allElements.showStudentAnalysisBtn.disabled=!0;const studentIndex=allElements.studentSelect.value;if(""===studentIndex)return;const studentSubmission=allSubmissions.filter(s=>s.Kelas===allElements.classSelect.value)[studentIndex];let quizSheetURL="";studentSubmission.Kelas.startsWith("Kelas XII")?quizSheetURL=quizURLs["Kelas XII"]:studentSubmission.Kelas.startsWith("Kelas XI")?quizSheetURL=quizURLs["Kelas XI"]:studentSubmission.Kelas.startsWith("Kelas X")&&(quizSheetURL=quizURLs["Kelas X"]);if(!quizSheetURL)return void(allElements.loadingStatus.textContent="Bank soal tidak ditemukan.");allQuestions=await fetchQuestionBank(quizSheetURL),allQuestions.length>0&&displayStudentAnalysis(studentSubmission,allQuestions),allElements.showStudentAnalysisBtn.disabled=!1}
        async function onShowClassAnalysis(){allElements.showClassAnalysisBtn.disabled=!0;const selectedClass=allElements.classSelect.value;if(!selectedClass)return;const submissionsForClass=allSubmissions.filter(s=>s.Kelas===selectedClass);if(0===submissionsForClass.length)return alert("Tidak ada data jawaban untuk kelas ini."),void(allElements.showClassAnalysisBtn.disabled=!1);let quizSheetURL="";selectedClass.startsWith("Kelas XII")?quizSheetURL=quizURLs["Kelas XII"]:selected-lg?quizSheetURL=quizURLs["Kelas XI"]:selectedClass.startsWith("Kelas X")&&(quizSheetURL=quizURLs["Kelas X"]);if(!quizSheetURL)return void(allElements.loadingStatus.textContent="Bank soal tidak ditemukan.");allQuestions=await fetchQuestionBank(quizSheetURL),allQuestions.length>0&&displayClassAnalysis(submissionsForClass,allQuestions),allElements.showClassAnalysisBtn.disabled=!1}
        async function generateClassAnalysisSummary(){const btn=document.getElementById("generate-summary-btn"),contentDiv=document.getElementById("ai-summary-content"),container=document.getElementById("ai-summary-container");btn.disabled=!0,contentDiv.innerHTML='<p class="text-center">Menganalisis data dan membuat ringkasan...</p>',container.classList.remove("hidden");const difficultQuestions=classAnalysisData.questionDetails.sort((a,b)=>a.persentaseBenar-b.persentaseBenar).slice(0,5),userQuery=`\n                Data Analisis:\n                - Kelas: ${classAnalysisData.className}\n                - Tipe Ujian: ${allElements.examTypeSelect.options[allElements.examTypeSelect.selectedIndex].text}\n                - Skor Rata-rata: ${classAnalysisData.averageScore}\n                - Jumlah Murid: ${classAnalysisData.studentCount}\n                - Detail Soal Paling Sulit (Nomor Soal, Teks, Persentase Benar): ${JSON.stringify(difficultQuestions)}\n            `,systemPrompt="Anda adalah seorang guru Sejarah dan analis pendidikan yang berpengalaman. Berdasarkan data analisis jawaban kelas yang diberikan, buatlah ringkasan singkat dalam format poin-poin (gunakan tanda '*' untuk setiap poin). Ringkasan harus mencakup:\n1.  **Performa Umum Kelas:** Berikan komentar singkat tentang performa kelas secara keseluruhan berdasarkan skor rata-rata.\n2.  **Soal-Soal Paling Sulit:** Identifikasi soal-soal dengan persentase jawaban benar terendah dari data yang diberikan.\n3.  **Potensi Kesalahan Konsep:** Berdasarkan soal-soal sulit tersebut, berikan analisis kemungkinan kesalahan konsep atau materi yang belum dipahami oleh sebagian besar murid.\n4.  **Rekomendasi Tindak Lanjut:** Berikan saran konkret untuk guru, seperti topik mana yang perlu diulang.\nGunakan bahasa Indonesia yang profesional dan mudah dimengerti.",apiKey="",apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`,payload={contents:[{parts:[{text:userQuery}]}],systemInstruction:{parts:[{text:systemPrompt}]}};try{const response=await fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!response.ok)throw new Error(`API Error: ${response.status}`);const result=await response.json();let text=result.candidates?.[0]?.content?.parts?.[0]?.text||"Tidak ada respons dari AI.";text=text.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),text=text.replace(/\*/g,"•"),contentDiv.innerHTML=`<div class="prose prose-sm max-w-none">${text.replace(/\n/g,"<br>")}</div>`}catch(error){console.error("Gemini API Error:",error),contentDiv.innerHTML='<p class="text-red-600">Terjadi kesalahan saat menghubungi AI. Silakan coba lagi nanti.</p>'}finally{btn.disabled=!1}}

        document.addEventListener("DOMContentLoaded",async()=>{await fetchTeacherCredentials()});
        allElements.examTypeSelect.addEventListener("change",async()=>{const type=allElements.examTypeSelect.value;allElements.classSelect.disabled=!0,allElements.analysisTypeSelection.classList.add("hidden"),allElements.studentAnalysisResultContainer.classList.add("hidden"),allElements.classAnalysisResultContainer.classList.add("hidden"),type&&(allSubmissions=await fetchSubmissions(answerSheetURLs[type]),populateClassSelect())});
        allElements.classSelect.addEventListener("change",()=>{allElements.studentSelect.disabled=!0,allElements.studentSelect.innerHTML='<option value="">-- Pilih Murid --</option>',allElements.showStudentAnalysisBtn.disabled=!0,allElements.studentAnalysisResultContainer.classList.add("hidden"),allElements.classAnalysisResultContainer.classList.add("hidden"),allElements.classSelect.value?(populateStudentSelect(),allElements.analysisTypeSelection.classList.remove("hidden"),allElements.studentSelect.disabled=!1):allElements.analysisTypeSelection.classList.add("hidden")});
        allElements.studentSelect.addEventListener("change",()=>{allElements.showStudentAnalysisBtn.disabled=""===allElements.studentSelect.value});
        allElements.showStudentAnalysisBtn.addEventListener("click",onShowStudentAnalysis),allElements.showClassAnalysisBtn.addEventListener("click",onShowClassAnalysis);
        allElements.submitLoginButton.addEventListener("click",handleLogin),allElements.teacherPasswordInput.addEventListener("keyup",event=>{"Enter"===event.key&&handleLogin()});
        allElements.tabMonitor.addEventListener("click",()=>switchTab("monitor")),allElements.tabHistory.addEventListener("click",()=>switchTab("history")),allElements.tabAnalysis.addEventListener("click",()=>switchTab("analysis"));
        allElements.monitorUtamaBtn.addEventListener("click",()=>showMonitoringScreen("utama")),allElements.monitorRemedialBtn.addEventListener("click",()=>showMonitoringScreen("remedial")),allElements.monitorBackButton.addEventListener("click",()=>{allElements.monitorDisplayScreen.classList.add("hidden"),allElements.monitorSelectionScreen.classList.remove("hidden"),unsubscribe&&unsubscribe()});
        allElements.historyList.addEventListener("click",handleDeleteRequest);
        allElements.clearHistoryModal.innerHTML=`<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg text-center"><h2 class="text-2xl font-bold text-red-600">Konfirmasi Hapus Riwayat</h2><p class="mt-4 text-slate-600">Apakah Anda yakin ingin menghapus <strong>SEMUA</strong> riwayat pelanggaran secara permanen? Tindakan ini tidak dapat diurungkan.</p><p id="clear-status" class="text-sm text-slate-500 mt-2 h-5"></p><div class="mt-8 flex justify-center gap-4"><button id="cancel-clear-history-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">Batal</button><button id="confirm-clear-history-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Ya, Hapus Semua</button></div></div>`;
        allElements.deleteEntryModal.innerHTML=`<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg text-center"><h2 class="text-2xl font-bold text-red-600">Konfirmasi Hapus</h2><p class="mt-4 text-slate-600">Apakah Anda yakin ingin menghapus riwayat pelanggaran untuk murid <strong id="student-name-to-delete"></strong>?</p><div class="mt-8 flex justify-center gap-4"><button id="cancel-delete-entry-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">Batal</button><button id="confirm-delete-entry-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Ya, Hapus</button></div></div>`;
        allElements.resetLiveModal.innerHTML=`<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg text-center"><h2 class="text-2xl font-bold text-orange-600">Konfirmasi Reset Sesi</h2><p class="mt-4 text-slate-600">Apakah Anda yakin ingin mereset <strong>SEMUA</strong> sesi live yang sedang berjalan? Semua data murid yang sedang mengerjakan di monitor akan dihapus.</p><p id="reset-live-status" class="text-sm text-slate-500 mt-2 h-5"></p><div class="mt-8 flex justify-center gap-4"><button id="cancel-reset-live-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">Batal</button><button id="confirm-reset-live-btn" class="bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-700">Ya, Reset Sesi</button></div></div>`;
        allElements.clearHistoryButton.addEventListener("click",()=>allElements.clearHistoryModal.classList.remove("hidden"));
        document.getElementById("cancel-clear-history-btn").addEventListener("click",()=>allElements.clearHistoryModal.classList.add("hidden"));
        document.getElementById("confirm-clear-history-btn").addEventListener("click",clearCheatingHistory);
        document.getElementById("cancel-delete-entry-btn").addEventListener("click",()=>allElements.deleteEntryModal.classList.add("hidden"));
        document.getElementById("confirm-delete-entry-btn").addEventListener("click",confirmDelete);
        allElements.resetLiveSessionButton.addEventListener('click',()=>allElements.resetLiveModal.classList.remove('hidden'));
        document.getElementById("cancel-reset-live-btn").addEventListener('click',()=>allElements.resetLiveModal.classList.add('hidden'));
        document.getElementById("confirm-reset-live-btn").addEventListener('click',clearLiveSession);
    </script>
</body>
</html>

